<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>

<!-- Main Content -->
<main class="main-content">
    <div class="content-wrapper">
        <div class="content-header flex items-center justify-between">
            <h2 class="content-title">Dashboard Overview</h2>
            <div class="flex items-center gap-4">
                <div id="updateNotification" class="hidden fixed bottom-4 right-4 z-50">
                    <a href="https://github.com/clusterzx/paperless-ai/releases/" target="_blank"
                        class="group flex items-center gap-3 bg-white px-4 py-3 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300">
                        <div class="flex items-center justify-center w-8 h-8 bg-blue-100 rounded-lg">
                            <i class="fas fa-arrow-up text-blue-500"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-gray-900">Update available</span>
                            <span class="text-xs text-gray-500">Click to download version <span id="latestVersion"></span></span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 group-hover:transform group-hover:translate-x-1 transition-all duration-300"></i>
                    </a>
                </div>
                <button
                    id="scanButton"
                    class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
                    onclick="triggerScan()"
                >
                    <i class="fas fa-sync-alt"></i>
                    <span>Scan now</span>
                </button>
                <!-- Success message toast -->
                <div id="successToast" class="hidden fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check"></i>
                        <span>Scan completed successfully!</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Cards -->
        <div class="card-grid">
            <!-- Document Chart -->
            <div class="material-card col-span-2">
                <%
                    const processingStats = paperless_data.processingBreakdown || {
                        totalCount: paperless_data.documentCount,
                        processedInScope: paperless_data.processedDocumentCount,
                        unprocessedInScope: Math.max(paperless_data.documentCount - paperless_data.processedDocumentCount, 0),
                        excludedCount: 0,
                        notIncludedCount: 0,
                        includeTagsActive: false,
                        excludeTagsActive: false
                    };
                %>
                <h3 class="card-title">Document Processing Status</h3>
                <div class="flex items-center">
                    <div class="w-1/2">
                        <canvas id="documentChart" height="200"></canvas>
                    </div>
                    <div class="w-1/2 pl-6">
                        <div class="stats-legend">
                            <div class="stat-item">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                                        <span>AI Processed</span>
                                    </div>
                                    <span class="font-semibold"><%= processingStats.processedInScope %></span>
                                </div>
                            </div>
                            <div class="stat-item mt-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 rounded-full bg-gray-200 mr-2"></div>
                                        <span>Unprocessed</span>
                                    </div>
                                    <span class="font-semibold"><%= processingStats.unprocessedInScope %></span>
                                </div>
                            </div>
                            <% if (processingStats.excludeTagsActive) { %>
                                <div class="stat-item mt-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-red-400 mr-2"></div>
                                            <span>Excluded by tags</span>
                                        </div>
                                        <span class="font-semibold"><%= processingStats.excludedCount %></span>
                                    </div>
                                </div>
                            <% } %>
                            <% if (processingStats.includeTagsActive) { %>
                                <div class="stat-item mt-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full bg-amber-400 mr-2"></div>
                                            <span>Not included</span>
                                        </div>
                                        <span class="font-semibold"><%= processingStats.notIncludedCount %></span>
                                    </div>
                                </div>
                            <% } %>
                            <div class="total-stats mt-6 pt-4 border-t">
                                <div class="text-sm text-gray-600">Total Documents</div>
                                <div class="text-2xl font-bold"><%= processingStats.totalCount %></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="material-card">
                <h3 class="card-title">System Statistics</h3>
                <div class="space-y-6">
                    <div class="stat-box cursor-pointer hover:shadow-lg transition-all" onclick="showTagDetails()">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-tags text-blue-500"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600">Total Tags</div>
                                    <div class="text-xl font-bold"><%= paperless_data.tagCount %></div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                    <div class="stat-box cursor-pointer hover:shadow-lg transition-all" onclick="showCorrespondentDetails()">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-building text-purple-500"></i>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600">Correspondents</div>
                                    <div class="text-xl font-bold"><%= paperless_data.correspondentCount %></div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Template -->
            <div id="detailsModal" class="modal hidden">
                <div class="modal-overlay"></div>
                <div class="modal-container">
                    <div class="modal-header">
                        <h3 class="modal-title"></h3>
                        <button class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-content">
                        <div class="modal-loader hidden">
                            <div class="loader"></div>
                        </div>
                        <div class="modal-data"></div>
                    </div>
                </div>
            </div>

            <!-- Token Usage Card -->
            <div class="material-card">
                <h3 class="card-title">AI Token Usage</h3>
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-600">Average Token Usage per Document</span>
                        </div>
                        <div class="mt-2 text-sm">
                            <div class="flex items-center justify-between mb-2">
                                <span>Prompt Tokens:</span>
                                <span class="font-semibold"><%= Math.round(openai_data.averagePromptTokens) %></span>
                            </div>
                            <div class="flex items-center justify-between mb-2">
                                <span>Completion Tokens:</span>
                                <span class="font-semibold"><%= Math.round(openai_data.averageCompletionTokens) %></span>
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t">
                                <span class="font-medium">Average Total:</span>
                                <span class="font-semibold"><%= Math.round(openai_data.averageTotalTokens) %></span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-600">Total Tokens Used</div>
                                    <div class="text-xl font-bold"><%= openai_data.tokensOverall.toLocaleString() %></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600">Documents Processed</div>
                                    <div class="text-xl font-bold"><%= paperless_data.processedDocumentCount.toLocaleString() %></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-grid mt-6">
            <!-- Task Runner Status -->
            <div class="material-card col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="card-title mb-0">Task Runner Status</h3>
                    <span id="statusLastUpdated" class="text-sm text-gray-500"></span>
                </div>

                <!-- Active Processing Card -->
                <div class="bg-white rounded-xl border border-gray-100 p-6 mb-4">
                    <div id="processingContainer" class="hidden">
                        <div class="flex items-center gap-4">
                            <!-- Spinner -->
                            <div class="relative">
                                <div class="w-12 h-12 rounded-full border-4 border-blue-100 border-t-blue-500 animate-spin"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <i class="fas fa-file text-blue-500 text-sm"></i>
                                </div>
                            </div>
                            <!-- Document Info -->
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-medium">Processing Document</span>
                                    <span id="currentDocId" class="text-sm bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full"></span>
                                </div>
                                <div id="currentDocTitle" class="text-sm text-gray-600 truncate"></div>
                            </div>
                        </div>
                    </div>

                    <div id="idleContainer" class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center">
                            <i class="fas fa-check text-gray-400"></i>
                        </div>
                        <div>
                            <div class="font-medium">System Idle</div>
                            <div class="text-sm text-gray-600">Waiting for new documents</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Today's Stats -->
                    <div class="bg-white rounded-xl border border-gray-100 p-4">
                        <div class="text-sm text-gray-600 mb-1">Processed Today</div>
                        <div class="flex items-end gap-2">
                            <span id="processedToday" class="text-2xl font-bold">0</span>
                            <span class="text-sm text-gray-500 mb-1">documents</span>
                        </div>
                    </div>

                    <!-- Last Processed -->
                    <div class="bg-white rounded-xl border border-gray-100 p-4">
                        <div class="text-sm text-gray-600 mb-1">Last Processed</div>
                        <div id="lastProcessed" class="text-sm font-medium"></div>
                    </div>
                </div>
            </div>

            <!-- Token Distribution Chart -->
            <div class="material-card">
                <h3 class="card-title">Token Usage Distribution</h3>
                <div class="chart-container">
                    <canvas id="tokenDistribution"></canvas>
                </div>
            </div>

            <!-- Document Types Chart -->
            <div class="material-card">
                <h3 class="card-title">Document Type Distribution</h3>
                <div class="chart-container">
                    <canvas id="documentTypes"></canvas>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="dashboard-data" class="hidden"
     data-token-distribution='<%- JSON.stringify(paperless_data.tokenDistribution) %>'
     data-document-types='<%- JSON.stringify(paperless_data.documentTypes) %>'
     data-version="<%= version %>"
     data-document-count="<%= paperless_data.documentCount %>"
     data-processed-count="<%= paperless_data.processedDocumentCount %>"
     data-processed-in-scope="<%= processingStats.processedInScope %>"
     data-unprocessed-in-scope="<%= processingStats.unprocessedInScope %>"
     data-excluded-count="<%= processingStats.excludedCount %>"
     data-not-included-count="<%= processingStats.notIncludedCount %>"
     data-include-tags-active="<%= processingStats.includeTagsActive ? 'true' : 'false' %>"
     data-exclude-tags-active="<%= processingStats.excludeTagsActive ? 'true' : 'false' %>"></div>
<script src="js/dashboard-page.js"></script>
<script src="js/dashboard.js"></script>
