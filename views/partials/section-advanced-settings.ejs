<%
const variant = locals.variant || 'setup';
const config = locals.config || {};
const includeRestrictions = locals.includeRestrictions === true;
const includeExternalApi = locals.includeExternalApi === true;
const paperlessCustomFields = Array.isArray(locals.paperlessCustomFields) ? locals.paperlessCustomFields : [];
const isSetup = variant === 'setup';
%>
<% if (isSetup) { %>
<section>
  <h2 class="section-title">
    <i class="fas fa-cog"></i>
    Advanced settings
  </h2>
  <div class="space-y-6">
    <div class="form-group space-y-4">
      <label class="flex items-center gap-2 font-medium">
        <i class="fas fa-clipboard-check text-blue-500"></i>
        Document processing
      </label>
      <p class="text-sm text-gray-500">Control automation, schedules, and tag-based filtering.</p>
      <div class="space-y-6">
        <div class="form-group">
          <label for="enableAutomaticProcessing">Enable automatic processing?</label>
          <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
            <label class="flex items-start cursor-pointer w-full">
              <input type="checkbox"
                  id="enableAutomaticProcessing"
                  class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                  <%= config.ENABLE_AUTOMATIC_PROCESSING ? 'checked' : '' %>>
              <div class="ml-3">
                <div class="flex items-center font-medium">
                  <i class="fas fa-robot text-blue-500 mr-2"></i>
                  Enable automatic processing
                </div>
                <p class="text-sm text-gray-500 mt-1">Determines if the AI will run on its own or every scan is started manually</p>
              </div>
            </label>
            <input type="hidden"
                  id="enableAutomaticProcessingValue"
                  name="enableAutomaticProcessing"
                  value="<%= config.ENABLE_AUTOMATIC_PROCESSING ? 'true' : 'false' %>">
          </div>
        </div>

        <div class="form-group">
          <div id="scanIntervalSection" class="<%= config.ENABLE_AUTOMATIC_PROCESSING ? '' : 'hidden' %>">
            <label for="scanInterval">Scan interval (cron format)</label>
            <input type="text"
                  id="scanInterval"
                  name="scanInterval"
                  value="<%= config.SCAN_INTERVAL %>"
                  class="modern-input"
                  required>
            <p class="help-text">Default: every 30 minutes</p>
          </div>
        </div>

        <div class="form-group">
          <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
            <label class="flex items-start cursor-pointer w-full">
              <input type="checkbox"
                    id="filterDocuments"
                    class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.FILTER_DOCUMENTS ? 'checked' : '' %>>
              <div class="ml-3">
                <div class="flex items-center font-medium">
                  <i class="fas fa-filter text-blue-500 mr-2"></i>
                  Filter documents by tags
                </div>
                <p class="text-sm text-gray-500 mt-1">Include or exclude documents based on their tags</p>
              </div>
            </label>
            <input type="hidden"
                  id="filterDocumentsValue"
                  name="filterDocuments"
                  value="<%= config.FILTER_DOCUMENTS ? 'true' : 'false' %>">
          </div>
        </div>

        <div id="tagsInputSection" class="<%= config.FILTER_DOCUMENTS ? '' : 'hidden' %>">
          <div class="form-group">
            <label for="tagInput">Include tags</label>
            <div class="tag-input-container">
              <input type="text"
                  id="tagInput"
                  class="modern-input"
                  placeholder="Enter a tag to include and press Enter">
              <button type="button"
                      class="material-button add-tag-btn">
                <i class="fas fa-plus"></i>
                Add
              </button>
            </div>
            <div id="tagsContainer" class="tags-container">
              <% if (config.FILTER_INCLUDE_TAGS && Array.isArray(config.FILTER_INCLUDE_TAGS) && config.FILTER_INCLUDE_TAGS.length > 0) { %>
                  <% config.FILTER_INCLUDE_TAGS.forEach(tag => { %>
                      <div class="modern-tag fade-in tag-chip">
                          <span><%= tag %></span>
                          <button type="button"><i class="fas fa-times"></i></button>
                      </div>
                  <% }); %>
              <% } %>
            </div>
            <input type="hidden" id="filterIncludeTags" name="filterIncludeTags" value="<%= Array.isArray(config.FILTER_INCLUDE_TAGS) ? config.FILTER_INCLUDE_TAGS.join(',') : '' %>">
          </div>
          <div class="form-group">
            <label for="excludeTagInput">Exclude tags</label>
            <div class="tag-input-container">
              <input type="text"
                  id="excludeTagInput"
                  class="modern-input"
                  placeholder="Enter a tag to exclude and press Enter">
              <button type="button"
                      class="material-button add-exclude-tag-btn">
                <i class="fas fa-minus"></i>
                Exclude
              </button>
            </div>
            <div id="excludeTagsContainer" class="tags-container">
              <% if (config.FILTER_EXCLUDE_TAGS && Array.isArray(config.FILTER_EXCLUDE_TAGS) && config.FILTER_EXCLUDE_TAGS.length > 0) { %>
                  <% config.FILTER_EXCLUDE_TAGS.forEach(tag => { %>
                      <div class="modern-tag fade-in tag-chip">
                          <span><%= tag %></span>
                          <button type="button"><i class="fas fa-times"></i></button>
                      </div>
                  <% }); %>
              <% } %>
            </div>
            <input type="hidden" id="filterExcludeTags" name="filterExcludeTags" value="<%= Array.isArray(config.FILTER_EXCLUDE_TAGS) ? config.FILTER_EXCLUDE_TAGS.join(',') : '' %>">
          </div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
        <label class="flex items-start cursor-pointer w-full">
          <input type="checkbox"
                 id="aiUseExistingData"
                 class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                 <%= config.AI_USE_EXISTING_DATA ? 'checked' : '' %>>
          <div class="ml-3">
            <div class="flex items-center font-medium">
              <i class="fas fa-database text-blue-500 mr-2"></i>
              Use existing correspondents and tags
            </div>
            <p class="text-sm text-gray-500 mt-1">Prefer existing metadata before creating new entries</p>
          </div>
        </label>
        <input type="hidden"
               id="aiUseExistingDataValue"
               name="aiUseExistingData"
               value="<%= config.AI_USE_EXISTING_DATA ? 'true' : 'false' %>">
      </div>
    </div>

    <% if (includeExternalApi) { %>
    <div class="border-t pt-4 space-y-4">
      <div class="space-y-2">
        <h3 class="text-lg font-medium flex items-center gap-2 text-primary">
          <i class="fas fa-plug"></i>
          External API integration
        </h3>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200 mb-4">
          <label for="externalApiEnabled" class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="externalApiEnabled"
                name="externalApiEnabled"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.EXTERNAL_API_ENABLED ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-globe text-blue-500 mr-2"></i>
                Enable external API integration
              </div>
              <p class="text-sm text-gray-500 mt-1">Enrich AI prompts with data from external API</p>
            </div>
          </label>
        </div>

        <div id="externalApiSettings" class="space-y-4 <%= config.EXTERNAL_API_ENABLED ? '' : 'hidden' %>">
          <div class="form-group">
            <label for="externalApiUrl">API URL</label>
            <input type="text"
                id="externalApiUrl"
                name="externalApiUrl"
                value="<%= config.EXTERNAL_API_URL || '' %>"
                class="modern-input"
                placeholder="https://api.example.com/data">
          </div>

          <div class="form-group">
            <label for="externalApiMethod">HTTP method</label>
            <select id="externalApiMethod"
                    name="externalApiMethod"
                    class="modern-input">
              <option value="GET" <%= config.EXTERNAL_API_METHOD === 'GET' ? 'selected' : '' %>>GET</option>
              <option value="POST" <%= config.EXTERNAL_API_METHOD === 'POST' ? 'selected' : '' %>>POST</option>
              <option value="PUT" <%= config.EXTERNAL_API_METHOD === 'PUT' ? 'selected' : '' %>>PUT</option>
            </select>
          </div>

          <div class="form-group">
            <label for="externalApiHeaders">Headers (JSON)</label>
            <textarea id="externalApiHeaders"
                      name="externalApiHeaders"
                      rows="3"
                      class="modern-input"
                      placeholder='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_TOKEN"}'><%= config.EXTERNAL_API_HEADERS || '' %></textarea>
          </div>

          <div class="form-group">
            <label for="externalApiBody">Request body (JSON) - for POST/PUT</label>
            <textarea id="externalApiBody"
                      name="externalApiBody"
                      rows="3"
                      class="modern-input"
                      placeholder='{"query": "your_query", "filters": {"key": "value"}}'><%= config.EXTERNAL_API_BODY || '' %></textarea>
          </div>

          <div class="form-group">
            <label for="externalApiTimeout">Timeout (milliseconds)</label>
            <input type="number"
                   id="externalApiTimeout"
                   name="externalApiTimeout"
                   value="<%= config.EXTERNAL_API_TIMEOUT || '5000' %>"
                   class="modern-input"
                   placeholder="5000">
          </div>

          <div class="form-group">
            <label for="externalApiTransform">Transform function (JavaScript)</label>
            <textarea id="externalApiTransform"
                      name="externalApiTransform"
                      rows="5"
                      class="modern-input"
                      placeholder="// Function to transform API response\n// Return the data you want to include in the prompt\nfunction transform(data) {\n  return data;\n}"><%= config.EXTERNAL_API_TRANSFORM || '// Function to transform API response\n// Return the data you want to include in the prompt\nfunction transform(data) {\n  return data;\n}' %></textarea>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <hr/>
    <div class="form-group">
      <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
        <label class="flex items-start cursor-pointer w-full">
          <input type="checkbox"
                 id="aiUsePromptTags"
                 class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                 <%= config.AI_USE_PROMPT_TAGS ? 'checked' : '' %>>
          <div class="ml-3">
            <div class="flex items-center font-medium">
              <i class="fas fa-hashtag text-blue-500 mr-2"></i>
              Use specific tags in prompt
            </div>
            <p class="text-sm text-gray-500 mt-1">Force the AI to use your prompt tag list</p>
          </div>
        </label>
        <input type="hidden"
               id="aiUsePromptTagsValue"
               name="aiUsePromptTags"
               value="<%= config.AI_USE_PROMPT_TAGS ? 'true' : 'false' %>">
      </div>
    </div>

    <div id="promptTagsSection" class="<%= config.AI_USE_PROMPT_TAGS ? '' : 'hidden' %>">
      <div class="form-group">
        <label for="promptTagInput">Prompt tags</label>
        <div class="tag-input-container">
          <input type="text"
              id="promptTagInput"
              class="modern-input"
              placeholder="Enter a tag and press Enter">
          <button type="button"
                  class="material-button add-prompt-tag-btn">
            <i class="fas fa-plus"></i>
            Add
          </button>
        </div>
        <div id="promptTagsContainer" class="tags-container">
          <% if (config.AI_PROMPT_TAGS && Array.isArray(config.AI_PROMPT_TAGS) && config.AI_PROMPT_TAGS.length > 0) { %>
              <% config.AI_PROMPT_TAGS.forEach(tag => { %>
                  <div class="modern-tag fade-in">
                      <span><%= tag %></span>
                      <button type="button"><i class="fas fa-times"></i></button>
                  </div>
              <% }); %>
          <% } %>
        </div>
        <input type="hidden" id="aiPromptTags" name="aiPromptTags" value="<%= Array.isArray(config.AI_PROMPT_TAGS) ? config.AI_PROMPT_TAGS.join(',') : '' %>">
        <p class="help-text">These tags will be exclusively used in the AI prompt</p>
      </div>
    </div>

    <hr/>
    <div class="form-group space-y-4">
      <label class="flex items-center gap-2 font-medium">
        <i class="fas fa-sliders-h text-blue-500"></i>
        Enable/Disable AI functions
      </label>
      <p class="text-sm text-gray-500">Select which functions the AI should perform during document analysis</p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableDocumentType"
                name="enableDocumentType"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_DOCUMENT_TYPE ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                Document type classification
              </div>
              <p class="text-sm text-gray-500 mt-1">Determine the type of document automatically</p>
            </div>
          </label>
        </div>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableTitle"
                name="enableTitle"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_TITLE ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-heading text-blue-500 mr-2"></i>
                Title generation
              </div>
              <p class="text-sm text-gray-500 mt-1">Generate meaningful titles for documents</p>
            </div>
          </label>
        </div>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableDocumentDate"
                name="enableDocumentDate"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_DOCUMENT_DATE ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                Document date extraction
              </div>
              <p class="text-sm text-gray-500 mt-1">Extract the document date (YYYY-MM-DD)</p>
            </div>
          </label>
        </div>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableLanguage"
                name="enableLanguage"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_LANGUAGE ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-language text-blue-500 mr-2"></i>
                Language detection
              </div>
              <p class="text-sm text-gray-500 mt-1">Detect the document language (e.g., de/en)</p>
            </div>
          </label>
        </div>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableTags"
                name="enableTags"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_TAGS ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-tags text-blue-500 mr-2"></i>
                Tags assignment
              </div>
              <p class="text-sm text-gray-500 mt-1">Automatically assign relevant tags to documents</p>
            </div>
          </label>
        </div>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableCorrespondent"
                name="enableCorrespondent"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_CORRESPONDENT ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-user text-blue-500 mr-2"></i>
                Correspondent detection
              </div>
              <p class="text-sm text-gray-500 mt-1">Identify document senders automatically</p>
            </div>
          </label>
        </div>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableContent"
                name="enableContent"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_CONTENT ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-align-left text-blue-500 mr-2"></i>
                Content update
              </div>
              <p class="text-sm text-gray-500 mt-1">Update document content with the AI-optimized text</p>
            </div>
          </label>
        </div>

        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                id="enableCustomFields"
                name="enableCustomFields"
                class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.ENABLE_CUSTOM_FIELDS ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-filter text-blue-500 mr-2"></i>
                Custom fields
              </div>
              <p class="text-sm text-gray-500 mt-1">Add custom fields to the documents</p>
            </div>
          </label>
        </div>
      </div>
    </div>

    <hr/>
    <section>
      <div class="form-group space-y-4" id="customFieldsSection">
        <label class="flex items-center gap-2 font-medium">
          <i class="fas fa-table text-blue-500"></i>
          Custom fields
        </label>
        <p class="text-sm text-gray-500">Configure custom fields that will be populated by AI during document analysis.</p>

        <div id="customFieldsList" class="space-y-2">
          <% if (config.AI_CUSTOM_FIELDS && Array.isArray(JSON.parse(config.AI_CUSTOM_FIELDS).custom_fields)) { %>
              <% JSON.parse(config.AI_CUSTOM_FIELDS).custom_fields.forEach((field, index) => { %>
                  <div class="custom-field-item flex items-center gap-2 p-3 bg-white rounded-lg border border-gray-200 hover:border-blue-200 transition-colors">
                      <div class="cursor-move text-gray-400">
                          <i class="fas fa-grip-vertical"></i>
                      </div>
                      <div class="flex-1 flex items-center gap-4">
                          <div class="flex-1">
                              <p class="font-medium"><%= field.name || field.value %></p>
                              <p class="text-sm text-gray-500">
                                  Type: <%= field.data_type %>
                                  <% if (field.data_type === 'monetary' && (field.currency || (field.extra_data && field.extra_data.default_currency))) { %>
                                      (<%= field.currency || (field.extra_data && field.extra_data.default_currency) %>)
                                  <% } %>
                              </p>
                          </div>
                      </div>
                      <button type="button"
                              onclick="removeCustomField(this)"
                              class="text-gray-400 hover:text-red-500 transition-colors">
                          <i class="fas fa-trash"></i>
                      </button>
                  </div>
              <% }); %>
          <% } %>
        </div>

        <div class="grid grid-cols-12 gap-3 mt-4">
          <div class="col-span-6">
            <input type="text"
                id="newFieldName"
                class="modern-input w-full"
                placeholder="Enter field name...">
          </div>

          <div class="col-span-2">
            <select id="newFieldType" class="modern-input w-full" onchange="toggleCurrencySelect()">
              <option value="string">Text</option>
              <option value="float">Number</option>
              <option value="integer">Integer</option>
              <option value="boolean">Boolean</option>
              <option value="date">Date</option>
              <option value="monetary">Currency</option>
              <option value="url">URL</option>
            </select>
          </div>

          <div class="col-span-2">
            <select id="currencyCode" class="modern-input w-full hidden">
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
              <option value="GBP">GBP</option>
              <option value="JPY">JPY</option>
              <option value="CHF">CHF</option>
              <option value="AUD">AUD</option>
              <option value="CAD">CAD</option>
              <option value="CNY">CNY</option>
              <option value="INR">INR</option>
              <option value="NZD">NZD</option>
            </select>
          </div>

          <div class="col-span-2">
            <button type="button"
                    onclick="addCustomField()"
                    class="material-button w-full flex items-center justify-center gap-2"
                    id="addFieldBtn">
              <i class="fas fa-plus"></i>
              Add
            </button>
          </div>
        </div>

        <input type="hidden"
            id="aiCustomFields"
            name="aiCustomFields"
            value="<%= config.AI_CUSTOM_FIELDS || '{"custom_fields":[]}' %>">
      </div>
    </section>

    <hr/>
    <div class="form-group">
      <label for="aiSystemPrompt">Prompt description</label>
      <div class="prompt-container">
        <textarea id="aiSystemPrompt"
                 name="aiSystemPrompt"
                 rows="8"
                 class="modern-input"
                 placeholder="Describe how the AI should analyze your documents..."><%= config.AI_SYSTEM_PROMPT %></textarea>
        <button id="systemPromptBtn" type="button"
                class="material-button example-btn">
          <i class="fas fa-lightbulb"></i>
          Example
        </button>
      </div>
    </div>

    <div class="form-group">
      <label for="mustHavePrompt">Must-have prompt (<em>(only appended, if placeholder <code>%JSON_SCHEMA%</code> is not present in Prompt above)</em>)</label>
      <textarea id="mustHavePrompt"
                name="mustHavePrompt"
                rows="6"
                class="modern-input"
                placeholder="mandatory appendix defined in application configuration"
                disabled><%= config.ai?.mustHavePrompt || '' %></textarea>
    </div>

    <hr/>
    <section class="space-y-4">
      <h3 class="text-lg font-medium flex items-center gap-2 text-primary">
        <i class="fas fa-wand-magic-sparkles"></i>
        AI result refinement
      </h3>
      <p class="text-sm text-gray-500">Fine-tune how AI results are constrained and labeled.</p>

      <div class="form-group">
        <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-start cursor-pointer w-full">
            <input type="checkbox"
                   id="addAiProcessedTag"
                   class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                   <%= config.ADD_AI_PROCESSED_TAG ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center font-medium">
                <i class="fas fa-tag text-blue-500 mr-2"></i>
                Add AI-processed tag to documents
              </div>
              <p class="text-sm text-gray-500 mt-1">Mark documents that were handled by the AI</p>
            </div>
          </label>
          <input type="hidden"
                 id="addAiProcessedTagValue"
                 name="addAiProcessedTag"
                 value="<%= config.ADD_AI_PROCESSED_TAG ? 'true' : 'false' %>">
        </div>
      </div>

      <div id="aiTagNameSection" class="<%= config.ADD_AI_PROCESSED_TAG ? '' : 'hidden' %>">
        <div class="form-group">
          <label for="aiProcessedTagName">AI-processed tag name</label>
          <input type="text"
              id="aiProcessedTagName"
              name="aiProcessedTagName"
              value="<%= config.AI_PROCESSED_TAG_NAME || 'ai-processed' %>"
              class="modern-input"
              placeholder="ai-processed">
          <p class="help-text">This tag will be added to documents after AI processing</p>
        </div>
      </div>

      <% if (includeRestrictions) { %>
      <div class="border-t pt-4 space-y-4">
        <div class="space-y-2">
          <h4 class="text-base font-medium flex items-center gap-2 text-primary">
            <i class="fas fa-filter"></i>
            AI restrictions
          </h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
              <label for="restrictToExistingTags" class="flex items-start cursor-pointer w-full">
                <input type="checkbox"
                    id="restrictToExistingTags"
                    name="restrictToExistingTags"
                    class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.RESTRICT_TO_EXISTING_TAGS ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center font-medium">
                    <i class="fas fa-tags text-blue-500 mr-2"></i>
                    Restrict to existing tags
                  </div>
                  <p class="text-sm text-gray-500 mt-1">AI will only use tags that already exist in Paperless-ngx</p>
                </div>
              </label>
            </div>

            <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
              <label for="restrictToExistingCorrespondents" class="flex items-start cursor-pointer w-full">
                <input type="checkbox"
                    id="restrictToExistingCorrespondents"
                    name="restrictToExistingCorrespondents"
                    class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.RESTRICT_TO_EXISTING_CORRESPONDENTS ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center font-medium">
                    <i class="fas fa-user text-blue-500 mr-2"></i>
                    Restrict to existing correspondents
                  </div>
                  <p class="text-sm text-gray-500 mt-1">AI will only use correspondents that already exist in Paperless-ngx</p>
                </div>
              </label>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="modern-card flex-1 p-4 rounded-lg border border-gray-200 hover:border-blue-500 transition-colors duration-200">
              <label for="restrictToExistingDocumentTypes" class="flex items-start cursor-pointer w-full">
                <input type="checkbox"
                    id="restrictToExistingDocumentTypes"
                    name="restrictToExistingDocumentTypes"
                    class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.RESTRICT_TO_EXISTING_DOCUMENT_TYPES ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center font-medium">
                    <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                    Restrict to existing document types
                  </div>
                  <p class="text-sm text-gray-500 mt-1">AI will only use document types that already exist in Paperless-ngx</p>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </section>
  </div>
</section>
<% } else { %>
<section class="space-y-6">
  <h2 class="text-xl font-bold flex items-center gap-2 text-primary mb-4">
    <i class="fas fa-cog"></i>
    Advanced settings
  </h2>
  <div class="space-y-2">
    <section class="space-y-4">
      <h2 class="text-lg font-semibold flex items-center gap-2 text-primary">
        <i class="fas fa-clipboard-check text-blue-500"></i>
        Document processing
      </h2>
      <p class="text-sm text-gray-500">Control automation, schedules, and tag-based filtering.</p>
      <div class="space-y-2">
      <label for="enableAutomaticProcessing" class="text-sm font-medium">Enable automatic processing?</label>
      <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
        <label for="enableAutomaticProcessing" class="flex items-center p-4 cursor-pointer w-full">
          <input type="checkbox"
                 id="enableAutomaticProcessing"
                 class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                 <%= config.ENABLE_AUTOMATIC_PROCESSING ? 'checked' : '' %>>
          <div class="ml-3">
            <div class="flex items-center text-gray-900 font-medium">
              <i class="fas fa-robot mr-2 text-blue-500"></i>
              Enable automatic processing
            </div>
            <p class="text-sm text-gray-500 mt-1">Determines if the AI will run on its own or every scan is started manually</p>
          </div>
        </label>
        <input type="hidden"
               id="enableAutomaticProcessingValue"
               name="enableAutomaticProcessing"
               value="<%= config.ENABLE_AUTOMATIC_PROCESSING ? 'true' : 'false' %>">
      </div>
      </div>

      <div class="space-y-2 <%= config.ENABLE_AUTOMATIC_PROCESSING ? '' : 'hidden' %>" id="scanIntervalSection">
      <label for="scanInterval" class="text-sm font-medium">Scan interval (cron format)</label>
      <input type="text"
             id="scanInterval"
             name="scanInterval"
             value="<%= config.SCAN_INTERVAL %>"
             class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
             required>
      <p class="text-sm text-gray-500">Default: every 30 minutes</p>
      </div>

      <div class="space-y-4">
      <div class="space-y-2">
        <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-center p-4 cursor-pointer w-full">
          <input type="checkbox"
                 id="filterDocuments"
                 class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                 <%= config.FILTER_DOCUMENTS ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center text-gray-900 font-medium">
                <i class="fas fa-filter mr-2 text-blue-500"></i>
                Filter documents by tags
              </div>
              <p class="text-sm text-gray-500 mt-1">Include or exclude documents based on their tags</p>
            </div>
          </label>
          <input type="hidden"
                 id="filterDocumentsValue"
                 name="filterDocuments"
                 value="<%= config.FILTER_DOCUMENTS ? 'true' : 'false' %>">
        </div>
      </div>

      <div id="tagsInputSection" class="<%= config.FILTER_DOCUMENTS ? '' : 'hidden' %> space-y-4">
      <div class="space-y-2">
          <label for="tagInput" class="text-sm font-medium">Include tags</label>
          <div class="flex gap-2">
            <input type="text"
                id="tagInput"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter a tag to include and press Enter">
            <button type="button"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 add-tag-btn">
              <i class="fas fa-plus mr-2"></i>
              Add
            </button>
          </div>
          <div id="tagsContainer" class="flex flex-wrap gap-2 mt-2">
            <% if (config.FILTER_INCLUDE_TAGS && Array.isArray(config.FILTER_INCLUDE_TAGS) && config.FILTER_INCLUDE_TAGS.length > 0) { %>
                <% config.FILTER_INCLUDE_TAGS.forEach(tag => { %>
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center gap-2 tag-chip">
                        <span><%= tag %></span>
                        <button type="button" class="hover:text-blue-600"><i class="fas fa-times"></i></button>
                    </div>
                <% }); %>
            <% } %>
          </div>
          <input type="hidden" id="filterIncludeTags" name="filterIncludeTags" value="<%= Array.isArray(config.FILTER_INCLUDE_TAGS) ? config.FILTER_INCLUDE_TAGS.join(',') : '' %>">
        </div>
        <div class="space-y-2">
          <label for="excludeTagInput" class="text-sm font-medium">Exclude tags</label>
          <div class="flex gap-2">
            <input type="text"
                id="excludeTagInput"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter a tag to exclude and press Enter">
            <button type="button"
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 add-exclude-tag-btn">
              <i class="fas fa-minus mr-2"></i>
              Exclude
            </button>
          </div>
          <div id="excludeTagsContainer" class="flex flex-wrap gap-2 mt-2">
            <% if (config.FILTER_EXCLUDE_TAGS && Array.isArray(config.FILTER_EXCLUDE_TAGS) && config.FILTER_EXCLUDE_TAGS.length > 0) { %>
                <% config.FILTER_EXCLUDE_TAGS.forEach(tag => { %>
                    <div class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full flex items-center gap-2 tag-chip">
                        <span><%= tag %></span>
                        <button type="button" class="hover:text-gray-600"><i class="fas fa-times"></i></button>
                    </div>
                <% }); %>
            <% } %>
          </div>
          <input type="hidden" id="filterExcludeTags" name="filterExcludeTags" value="<%= Array.isArray(config.FILTER_EXCLUDE_TAGS) ? config.FILTER_EXCLUDE_TAGS.join(',') : '' %>">
        </div>
      </div>
    </div>
    </section>

    <div class="space-y-4">
      <div class="space-y-2">
        <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-center p-4 cursor-pointer w-full">
            <input type="checkbox"
                id="aiUseExistingData"
                class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.AI_USE_EXISTING_DATA ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center text-gray-900 font-medium">
                <i class="fas fa-database mr-2 text-blue-500"></i>
                Use existing correspondents and tags
              </div>
              <p class="text-sm text-gray-500 mt-1">Prefer existing metadata before creating new entries</p>
            </div>
          </label>
          <input type="hidden"
              id="aiUseExistingDataValue"
              name="aiUseExistingData"
              value="<%= config.AI_USE_EXISTING_DATA ? 'true' : 'false' %>">
        </div>
      </div>
    </div>

    <% if (includeExternalApi) { %>
    <div class="border-t pt-4 space-y-4">
      <div class="space-y-2">
        <h3 class="text-lg font-medium flex items-center gap-2 text-primary">
          <i class="fas fa-plug"></i>
          External API integration
        </h3>

        <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200 mb-4">
          <label for="externalApiEnabled" class="flex items-center p-4 cursor-pointer w-full">
            <input type="checkbox"
                id="externalApiEnabled"
                name="externalApiEnabled"
                class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                <%= config.EXTERNAL_API_ENABLED ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center text-gray-900 font-medium">
                <i class="fas fa-globe mr-2 text-blue-500"></i>
                Enable external API integration
              </div>
              <p class="text-sm text-gray-500 mt-1">Enrich AI prompts with data from external API</p>
            </div>
          </label>
        </div>

      <div id="externalApiSettings" class="space-y-4 <%= config.EXTERNAL_API_ENABLED ? '' : 'hidden' %>">
          <div class="space-y-2">
            <label for="externalApiUrl" class="text-sm font-medium">API URL</label>
            <input type="text"
                id="externalApiUrl"
                name="externalApiUrl"
                value="<%= config.EXTERNAL_API_URL || '' %>"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="https://api.example.com/data">
          </div>

          <div class="space-y-2">
            <label for="externalApiMethod" class="text-sm font-medium">HTTP method</label>
            <select id="externalApiMethod"
                    name="externalApiMethod"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="GET" <%= config.EXTERNAL_API_METHOD === 'GET' ? 'selected' : '' %>>GET</option>
              <option value="POST" <%= config.EXTERNAL_API_METHOD === 'POST' ? 'selected' : '' %>>POST</option>
              <option value="PUT" <%= config.EXTERNAL_API_METHOD === 'PUT' ? 'selected' : '' %>>PUT</option>
            </select>
          </div>

          <div class="space-y-2">
            <label for="externalApiHeaders" class="text-sm font-medium">Headers (JSON)</label>
            <textarea id="externalApiHeaders"
                      name="externalApiHeaders"
                      rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_TOKEN"}'><%= config.EXTERNAL_API_HEADERS || '' %></textarea>
          </div>

          <div class="space-y-2">
            <label for="externalApiBody" class="text-sm font-medium">Request body (JSON) - for POST/PUT</label>
            <textarea id="externalApiBody"
                      name="externalApiBody"
                      rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder='{"query": "your_query", "filters": {"key": "value"}}'><%= config.EXTERNAL_API_BODY || '' %></textarea>
          </div>

          <div class="space-y-2">
            <label for="externalApiTimeout" class="text-sm font-medium">Timeout (milliseconds)</label>
            <input type="number"
                   id="externalApiTimeout"
                   name="externalApiTimeout"
                   value="<%= config.EXTERNAL_API_TIMEOUT || '5000' %>"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   placeholder="5000">
          </div>

          <div class="space-y-2">
            <label for="externalApiTransform" class="text-sm font-medium">Transform function (JavaScript)</label>
            <textarea id="externalApiTransform"
                      name="externalApiTransform"
                      rows="5"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="// Function to transform API response\n// Return the data you want to include in the prompt\nfunction transform(data) {\n  return data;\n}"><%= config.EXTERNAL_API_TRANSFORM || '// Function to transform API response\n// Return the data you want to include in the prompt\nfunction transform(data) {\n  return data;\n}' %></textarea>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <div class="border-t pt-4 space-y-4">
      <div class="space-y-2">
        <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-center p-4 cursor-pointer w-full">
            <input type="checkbox"
                   id="aiUsePromptTags"
                   class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                   <%= config.AI_USE_PROMPT_TAGS ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center text-gray-900 font-medium">
                <i class="fas fa-hashtag mr-2 text-blue-500"></i>
                Use specific tags in prompt
              </div>
              <p class="text-sm text-gray-500 mt-1">Force the AI to use your prompt tag list</p>
            </div>
          </label>
          <input type="hidden"
                 id="aiUsePromptTagsValue"
                 name="aiUsePromptTags"
                 value="<%= config.AI_USE_PROMPT_TAGS ? 'true' : 'false' %>">
        </div>
      </div>

      <div id="promptTagsSection" class="<%= config.AI_USE_PROMPT_TAGS ? '' : 'hidden' %> space-y-4">
        <div class="space-y-2">
          <label for="promptTagInput" class="text-sm font-medium">Prompt tags</label>
          <div class="flex gap-2">
            <input type="text"
                id="promptTagInput"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="Enter a tag and press Enter">
            <button type="button"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              <i class="fas fa-plus mr-2"></i>
              Add
            </button>
          </div>
          <div id="promptTagsContainer" class="flex flex-wrap gap-2 mt-2">
            <% if (config.AI_PROMPT_TAGS && Array.isArray(config.AI_PROMPT_TAGS) && config.AI_PROMPT_TAGS.length > 0) { %>
                <% config.AI_PROMPT_TAGS.forEach(tag => { %>
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center gap-2">
                        <span><%= tag %></span>
                        <button type="button" class="hover:text-blue-600"><i class="fas fa-times"></i></button>
                    </div>
                <% }); %>
            <% } %>
          </div>
          <input type="hidden" id="aiPromptTags" name="aiPromptTags" value="<%= Array.isArray(config.AI_PROMPT_TAGS) ? config.AI_PROMPT_TAGS.join(',') : '' %>">
          <p class="text-sm text-gray-500">These tags will be exclusively used in the AI prompt</p>
        </div>
      </div>
    </div>

    <hr class="my-6"/>
    <section class="space-y-6">
      <h2 class="text-xl font-bold flex items-center gap-2 text-primary mb-4">
        <i class="fas fa-tasks"></i>
        AI function limits
      </h2>
      <div class="space-y-4">
        <div class="space-y-2">
          <label class="text-sm font-medium">Enable/Disable AI functions</label>
          <p class="text-sm text-gray-500 mb-4">Select which functions the AI should perform during document analysis</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="documentType" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableDocumentType"
                        name="enableDocumentType"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_DOCUMENT_TYPE ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-file-alt mr-2 text-blue-500"></i>
                    Document type classification
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Determine the type of document automatically</p>
                </div>
              </label>
            </div>

            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="title" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableTitle"
                        name="enableTitle"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_TITLE ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-heading mr-2 text-blue-500"></i>
                    Title generation
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Generate meaningful titles for documents</p>
                </div>
              </label>
            </div>

            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="documentDate" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableDocumentDate"
                        name="enableDocumentDate"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_DOCUMENT_DATE ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                    Document date extraction
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Extract the document date (YYYY-MM-DD)</p>
                </div>
              </label>
            </div>

            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="language" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableLanguage"
                        name="enableLanguage"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_LANGUAGE ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-language mr-2 text-blue-500"></i>
                    Language detection
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Detect the document language (e.g., de/en)</p>
                </div>
              </label>
            </div>

            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="tags" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableTags"
                        name="enableTags"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_TAGS ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-tags mr-2 text-blue-500"></i>
                    Tags assignment
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Automatically assign relevant tags to documents</p>
                </div>
              </label>
            </div>

            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="correspondent" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableCorrespondent"
                        name="enableCorrespondent"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_CORRESPONDENT ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-user mr-2 text-blue-500"></i>
                    Correspondent detection
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Identify document senders automatically</p>
                </div>
              </label>
            </div>

            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="content" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableContent"
                        name="enableContent"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_CONTENT ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-align-left mr-2 text-blue-500"></i>
                    Content update
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Update document content with the AI-optimized text</p>
                </div>
              </label>
            </div>

            <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
              <label for="customFields" class="flex items-center p-4 cursor-pointer w-full">
                    <input type="checkbox"
                        id="enableCustomFields"
                        name="enableCustomFields"
                    class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    <%= config.ENABLE_CUSTOM_FIELDS ? 'checked' : '' %>>
                <div class="ml-3">
                  <div class="flex items-center text-gray-900 font-medium">
                    <i class="fas fa-filter mr-2 text-blue-500"></i>
                    Custom fields
                  </div>
                  <p class="text-sm text-gray-500 mt-1">Add custom fields to the documents</p>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="space-y-6">
      <h2 class="text-xl font-bold flex items-center gap-2 text-primary mb-4">
        <i class="fas fa-table"></i>
        Custom fields
      </h2>
      <div class="space-y-4">
        <%
          const rawCustomFieldsConfig = config.AI_CUSTOM_FIELDS || '{"custom_fields":[]}';
          let customFieldsConfig = { custom_fields: [] };
          try {
            customFieldsConfig = JSON.parse(rawCustomFieldsConfig);
          } catch (error) {
            customFieldsConfig = { custom_fields: [] };
          }
          const storedFields = Array.isArray(customFieldsConfig.custom_fields) ? customFieldsConfig.custom_fields : [];
          const storedByName = {};
          storedFields.forEach((field) => {
            const key = (field?.name || field?.value || '').toLowerCase();
            if (key) storedByName[key] = field;
          });

          const dataTypeIcon = (type) => {
            switch (type) {
              case 'boolean':
                return 'fa-toggle-on';
              case 'date':
                return 'fa-calendar-alt';
              case 'integer':
              case 'float':
                return 'fa-hashtag';
              case 'monetary':
                return 'fa-coins';
              case 'url':
                return 'fa-link';
              case 'select':
                return 'fa-list';
              case 'longtext':
                return 'fa-align-left';
              default:
                return 'fa-font';
            }
          };

          const defaultDescription = (field, options, defaultCurrency) => {
            const name = field?.name || 'field';
            switch (field?.data_type) {
              case 'date':
                return `Extract the date for "${name}" (YYYY-MM-DD).`;
              case 'boolean':
                return `Set "${name}" to true or false based on the document.`;
              case 'integer':
                return `Extract the integer value for "${name}".`;
              case 'float':
                return `Extract the numeric value for "${name}".`;
              case 'monetary':
                return `Extract the monetary amount for "${name}" (number only${defaultCurrency ? `, ${defaultCurrency}` : ''}).`;
              case 'url':
                return `Extract the URL for "${name}".`;
              case 'select':
                return options.length > 0
                  ? `Choose one of the predefined options for "${name}".`
                  : `Choose the most suitable option for "${name}".`;
              case 'longtext':
                return `Extract a detailed text for "${name}".`;
              default:
                return `Extract the value for "${name}".`;
            }
          };

          const selectableFields = paperlessCustomFields.filter((field) => field && field.data_type !== 'documentlink');
        %>

        <% if (selectableFields.length === 0) { %>
          <p class="text-sm text-gray-500">No custom fields available from Paperless-ngx.</p>
        <% } %>

        <div id="customFieldsList" class="space-y-3">
          <% selectableFields.forEach((field) => { %>
            <%
              const stored = storedByName[(field.name || '').toLowerCase()] || {};
              const enabled = stored.enabled !== undefined ? Boolean(stored.enabled) : Boolean(stored.name || stored.value);
              const extraData = field.extra_data || {};
              const selectOptions = Array.isArray(extraData.select_options)
                ? extraData.select_options.map((option) => (typeof option === 'string' ? option : option?.label)).filter(Boolean)
                : [];
              const defaultCurrency = extraData.default_currency || '';
              const description = stored.description && String(stored.description).trim()
                ? stored.description
                : defaultDescription(field, selectOptions, defaultCurrency);
              const iconClass = dataTypeIcon(field.data_type);
            %>
            <div class="custom-field-item border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200 p-4 space-y-3"
                 data-field-name="<%= field.name %>"
                 data-field-type="<%= field.data_type %>"
                 data-field-extra="<%= JSON.stringify(extraData || {}) %>">
              <div class="flex items-start justify-between gap-4">
                <div class="flex items-start gap-3">
                  <div class="text-blue-500 mt-1">
                    <i class="fas <%= iconClass %>"></i>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900 dark:text-gray-100"><%= field.name %></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Type: <%= field.data_type %></p>
                  </div>
                </div>
                <label class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-200">
                  <input type="checkbox"
                         class="custom-field-toggle w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                         <%= enabled ? 'checked' : '' %>>
                  Enabled
                </label>
              </div>
              <% if (field.data_type === 'select') { %>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  Options: <%= selectOptions.length > 0 ? selectOptions.join(', ') : 'No options configured' %>
                </div>
              <% } %>
              <% if (field.data_type === 'monetary' && defaultCurrency) { %>
                <div class="text-xs text-gray-500 dark:text-gray-400">Default currency: <%= defaultCurrency %></div>
              <% } %>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-200">Schema description</label>
                <input type="text"
                       class="custom-field-description w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                       value="<%= description %>"
                       placeholder="Describe how the AI should fill this field">
              </div>
            </div>
          <% }); %>
        </div>

        <input type="hidden"
               id="aiCustomFields"
               name="aiCustomFields"
               value="<%= config.AI_CUSTOM_FIELDS || '{\"custom_fields\":[]}' %>">
      </div>
    </section>

    <div class="border-t pt-4 space-y-4">
      <div class="space-y-2">
        <label for="aiSystemPrompt" class="text-sm font-medium">Prompt description</label>
        <div class="space-y-2">
          <textarea id="aiSystemPrompt"
                    name="aiSystemPrompt"
                    rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Describe how the AI should analyze your documents..."><%= config.AI_SYSTEM_PROMPT %></textarea>
          <button id="systemPromptBtn" type="button"
                  class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 inline-flex items-center gap-2">
            <i class="fas fa-lightbulb"></i>
            Example
          </button>
        </div>
      </div>
    </div>

    <div class="border-t pt-4 space-y-4">
      <div class="space-y-2">
        <label for="mustHavePrompt" class="text-sm font-medium">Must-have prompt (<em>(only appended, if placeholder <code>%JSON_SCHEMA%</code> is not present in Prompt above)</em>)</label>
        <div class="space-y-2">
          <textarea id="mustHavePrompt"
                    name="mustHavePrompt"
                    rows="6"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="mandatory appendix defined in application configuration"
                    disabled><%= config.ai?.mustHavePrompt || '' %></textarea>
        </div>
      </div>
    </div>

    <div class="border-t pt-4 space-y-4">
      <h3 class="text-lg font-semibold flex items-center gap-2 text-primary">
        <i class="fas fa-wand-magic-sparkles text-blue-500"></i>
        AI result refinement
      </h3>
      <p class="text-sm text-gray-500">Fine-tune how AI results are constrained and labeled.</p>

      <div class="space-y-2">
        <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
          <label class="flex items-center p-4 cursor-pointer w-full">
            <input type="checkbox"
                   id="addAiProcessedTag"
                   class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                   <%= config.ADD_AI_PROCESSED_TAG ? 'checked' : '' %>>
            <div class="ml-3">
              <div class="flex items-center text-gray-900 font-medium">
                <i class="fas fa-tag mr-2 text-blue-500"></i>
                Add AI-processed tag to documents
              </div>
              <p class="text-sm text-gray-500 mt-1">Mark documents that were handled by the AI</p>
            </div>
          </label>
          <input type="hidden"
                 id="addAiProcessedTagValue"
                 name="addAiProcessedTag"
                 value="<%= config.ADD_AI_PROCESSED_TAG ? 'true' : 'false' %>">
        </div>
      </div>

      <div id="aiTagNameSection" class="<%= config.ADD_AI_PROCESSED_TAG ? '' : 'hidden' %> space-y-2">
        <label for="aiProcessedTagName" class="text-sm font-medium">AI-processed tag name</label>
        <input type="text"
            id="aiProcessedTagName"
            name="aiProcessedTagName"
            value="<%= config.AI_PROCESSED_TAG_NAME || 'ai-processed' %>"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="ai-processed">
        <p class="text-sm text-gray-500">This tag will be added to documents after AI processing</p>
      </div>

      <% if (includeRestrictions) { %>
      <div class="space-y-2">
        <h4 class="text-base font-medium flex items-center gap-2 text-primary">
          <i class="fas fa-filter"></i>
          AI restrictions
        </h4>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
            <label for="restrictToExistingTags" class="flex items-center p-4 cursor-pointer w-full">
              <input type="checkbox"
                  id="restrictToExistingTags"
                  name="restrictToExistingTags"
                  class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                  <%= config.RESTRICT_TO_EXISTING_TAGS ? 'checked' : '' %>>
              <div class="ml-3">
                <div class="flex items-center text-gray-900 font-medium">
                  <i class="fas fa-tags mr-2 text-blue-500"></i>
                  Restrict to existing tags
                </div>
                <p class="text-sm text-gray-500 mt-1">AI will only use tags that already exist in Paperless-ngx</p>
              </div>
            </label>
          </div>

          <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
            <label for="restrictToExistingCorrespondents" class="flex items-center p-4 cursor-pointer w-full">
              <input type="checkbox"
                  id="restrictToExistingCorrespondents"
                  name="restrictToExistingCorrespondents"
                  class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                  <%= config.RESTRICT_TO_EXISTING_CORRESPONDENTS ? 'checked' : '' %>>
              <div class="ml-3">
                <div class="flex items-center text-gray-900 font-medium">
                  <i class="fas fa-user mr-2 text-blue-500"></i>
                  Restrict to existing correspondents
                </div>
                <p class="text-sm text-gray-500 mt-1">AI will only use correspondents that already exist in Paperless-ngx</p>
              </div>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="border border-gray-200 shadow-sm rounded-lg hover:border-blue-500 transition-colors duration-200">
            <label for="restrictToExistingDocumentTypes" class="flex items-center p-4 cursor-pointer w-full">
              <input type="checkbox"
                  id="restrictToExistingDocumentTypes"
                  name="restrictToExistingDocumentTypes"
                  class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                  <%= config.RESTRICT_TO_EXISTING_DOCUMENT_TYPES ? 'checked' : '' %>>
              <div class="ml-3">
                <div class="flex items-center text-gray-900 font-medium">
                  <i class="fas fa-file-alt mr-2 text-blue-500"></i>
                  Restrict to existing document types
                </div>
                <p class="text-sm text-gray-500 mt-1">AI will only use document types that already exist in Paperless-ngx</p>
              </div>
            </label>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</section>
<% } %>
